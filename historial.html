<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Solicitudes - Sistema de Insumos</title>
    <link rel="stylesheet" href="css/styles.css">
    <meta name="description" content="Historial personal de solicitudes de insumos">
    <script>
        (function () {
            const session = sessionStorage.getItem('currentUser');
            if (!session) {
                window.location.replace('/login.html');
                return;
            }
        })();
    </script>
</head>

<body>
    <!-- Header se carga aquí -->
    <div id="header-container"></div>

    <main class="main-content">
        <!-- Header de la página -->
        <section class="page-header">
            <div class="container">
                <div class="page-title-section">
                    <h1>Mi Historial de Solicitudes</h1>
                    <p>Consulta el estado de tus solicitudes y marca como recibidas</p>
                </div>

                <!-- Estado del token del usuario -->
                <div class="token-status-card">
                    <div class="token-info">
                        <span class="token-label">Token disponible:</span>
                        <span class="token-value" id="userTokenStatus">-</span>
                    </div>
                    <div class="token-description">
                        <small id="tokenMessage">Marca tus solicitudes como "recibidas" para renovar tu token</small>
                    </div>
                </div>
            </div>
        </section>

        <!-- Filtros y controles -->
        <section class="controles-section">
            <div class="container">
                <div class="controles-wrapper">
                    <div class="filtros-group">
                        <label for="filtroTipo">Filtrar por tipo:</label>
                        <select id="filtroTipo" onchange="filtrarSolicitudes()">
                            <option value="">Todas</option>
                            <option value="ordinaria">Ordinarias</option>
                            <option value="juntas">Para Juntas</option>
                        </select>

                        <!-- NUEVO: Filtro por recurso -->
                        <div class="filtros-group">
                            <label for="filtroRecurso">Filtrar por recurso:</label>
                            <select id="filtroRecurso" onchange="filtrarSolicitudes()">
                                <option value="todos">Todos</option>
                                <option value="insumo">Insumos</option>
                                <option value="papeleria">Papelería</option>
                            </select>
                        </div>

                        <label for="filtroEstado">Filtrar por estado:</label>
                        <select id="filtroEstado" onchange="filtrarSolicitudes()">
                            <option value="">Todos</option>
                            <option value="pendiente">Pendientes</option>
                            <option value="en_revision">En Revisión</option>
                            <option value="cerrado">Cerradas</option>
                        </select>
                    </div>

                    <div class="acciones-group">
                        <button class="btn-secondary" onclick="recargarHistorial()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
                                <path d="M3 3v5h5" />
                                <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16" />
                                <path d="M16 16h5v5" />
                            </svg>
                            Actualizar
                        </button>

                        <a href="index.html" class="btn-primary">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                                <polyline points="9,22 9,12 15,12 15,22" />
                            </svg>
                            Nueva Solicitud
                        </a>
                    </div>
                </div>
            </div>
        </section>

        <!-- Lista de solicitudes -->
        <section class="solicitudes-historial">
            <div class="container">
                <div class="historial-content">

                    <!-- Loading state -->
                    <div class="loading-historial" id="loadingHistorial">
                        <div class="loading-spinner"></div>
                        <p>Cargando historial...</p>
                    </div>

                    <!-- Lista de solicitudes -->
                    <div class="solicitudes-lista" id="solicitudesLista" style="display: none;">
                        <!-- Se cargan dinámicamente -->
                    </div>

                    <!-- Estado vacío -->
                    <div class="historial-vacio" id="historialVacio" style="display: none;">
                        <div class="vacio-content">
                            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.5">
                                <path d="M9 12l2 2 4-4" />
                                <path d="M21 12c-1 0-3-1-3-3s2-3 3-3 3 1 3 3-2 3-3 3" />
                                <path d="M3 12c1 0 3-1 3-3s-2-3-3-3-3 1-3 3 2 3 3 3" />
                                <path d="M12 3c0 1-1 3-3 3s-3-2-3-3 1-3 3-3 3 2 3 3" />
                                <path d="M12 21c0-1 1-3 3-3s3 2 3 3-1 3-3 3-3-2-3-3" />
                            </svg>
                            <h3>No hay solicitudes</h3>
                            <p>Aún no has creado ninguna solicitud de insumos</p>
                            <a href="index.html" class="btn-primary">Crear Primera Solicitud</a>
                        </div>
                    </div>

                </div>
            </div>
        </section>
    </main>

    <!-- Footer se carga aquí -->
    <div id="footer-container"></div>

    <!-- Modal de confirmación para marcar recibido -->
    <div id="recibido-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content confirm-modal">
            <div class="modal-header">
                <h3>Confirmar Recepción</h3>
                <button class="modal-close" onclick="cerrarModalRecibido()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="confirm-content">
                    <div class="confirm-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M9 12l2 2 4-4" />
                            <circle cx="12" cy="12" r="10" />
                        </svg>
                    </div>
                    <h4>¿Has recibido todos los insumos?</h4>
                    <p>Al confirmar que recibiste esta solicitud, tu token mensual se reactivará inmediatamente.</p>

                    <div class="solicitud-resumen" id="resumenSolicitud">
                        <!-- Detalles de la solicitud -->
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="cerrarModalRecibido()">
                        Cancelar
                    </button>
                    <button type="button" class="btn-success" onclick="confirmarRecibido()" id="btnConfirmarRecibido">
                        Sí, he recibido todo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/script.js"></script>
    <script src="js/historial.js"></script>
</body>

</html>