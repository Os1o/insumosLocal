<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Historial - Diagn√≥stico</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.pending { background: #ffd700; color: #333; }
        .status.success { background: #4caf50; color: white; }
        .status.error { background: #f44336; color: white; }
        .log {
            background: #f9f9f9;
            padding: 10px;
            border-left: 3px solid #2196f3;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #1976d2;
        }
        .error-text {
            color: #f44336;
            font-weight: bold;
        }
        .success-text {
            color: #4caf50;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üîç Test de Historial - Diagn√≥stico Completo</h1>

    <!-- Test 1: Verificar API Adapter -->
    <div class="test-card">
        <div class="test-header">
            <h3>Test 1: API Adapter Cargado</h3>
            <span class="status pending" id="status1">PENDIENTE</span>
        </div>
        <div class="log" id="log1">Esperando prueba...</div>
        <button onclick="test1()">Ejecutar Test 1</button>
    </div>

    <!-- Test 2: Verificar Sesi√≥n -->
    <div class="test-card">
        <div class="test-header">
            <h3>Test 2: Sesi√≥n de Usuario</h3>
            <span class="status pending" id="status2">PENDIENTE</span>
        </div>
        <div class="log" id="log2">Esperando prueba...</div>
        <button onclick="test2()">Ejecutar Test 2</button>
    </div>

    <!-- Test 3: Test de Conexi√≥n API -->
    <div class="test-card">
        <div class="test-header">
            <h3>Test 3: Conexi√≥n con API Backend</h3>
            <span class="status pending" id="status3">PENDIENTE</span>
        </div>
        <div class="log" id="log3">Esperando prueba...</div>
        <button onclick="test3()">Ejecutar Test 3</button>
    </div>

    <!-- Test 4: Obtener Historial -->
    <div class="test-card">
        <div class="test-header">
            <h3>Test 4: Obtener Historial de Solicitudes</h3>
            <span class="status pending" id="status4">PENDIENTE</span>
        </div>
        <div class="log" id="log4">Esperando prueba...</div>
        <button onclick="test4()">Ejecutar Test 4</button>
    </div>

    <!-- Test 5: Obtener Solicitudes Recibidas -->
    <div class="test-card">
        <div class="test-header">
            <h3>Test 5: Obtener Solicitudes Recibidas</h3>
            <span class="status pending" id="status5">PENDIENTE</span>
        </div>
        <div class="log" id="log5">Esperando prueba...</div>
        <button onclick="test5()">Ejecutar Test 5</button>
    </div>

    <!-- Test 6: Marcar como Recibido -->
    <div class="test-card">
        <div class="test-header">
            <h3>Test 6: Marcar Solicitud como Recibida</h3>
            <span class="status pending" id="status6">PENDIENTE</span>
        </div>
        <div>
            <input type="text" id="solicitudIdTest" placeholder="ID de solicitud (opcional)" style="padding: 8px; width: 300px; margin-bottom: 10px;">
        </div>
        <div class="log" id="log6">Esperando prueba...</div>
        <button onclick="test6()">Ejecutar Test 6</button>
    </div>

    <div style="text-align: center; margin-top: 30px;">
        <button onclick="ejecutarTodos()" style="background: #4caf50; font-size: 16px; padding: 15px 30px;">
            ‚ñ∂ Ejecutar Todos los Tests
        </button>
    </div>

    <!-- Cargar el API Adapter PRIMERO -->
    <script src="js/api-adapter.js"></script>

    <script>
        // Usar la URL del API Adapter ya cargado
        const API_TEST_URL = 'http://11.254.27.18/insumos/api/endpoints';

        function log(testNum, message, isError = false) {
            const logDiv = document.getElementById(`log${testNum}`);
            const timestamp = new Date().toLocaleTimeString();
            const color = isError ? 'color: #f44336' : 'color: #333';
            logDiv.innerHTML += `<div style="${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function setStatus(testNum, status) {
            const statusDiv = document.getElementById(`status${testNum}`);
            statusDiv.className = `status ${status}`;
            statusDiv.textContent = status.toUpperCase();
        }

        // Test 1: Verificar que API Adapter est√© cargado
        function test1() {
            const logDiv = document.getElementById('log1');
            logDiv.innerHTML = '';
            log(1, 'üîÑ Iniciando Test 1...');

            if (typeof window.API !== 'undefined') {
                log(1, '‚úÖ window.API existe');
                log(1, `‚úÖ M√©todos disponibles: ${Object.keys(window.API).join(', ')}`);
                setStatus(1, 'success');
            } else {
                log(1, '‚ùå window.API NO est√° definido', true);
                log(1, 'üí° Aseg√∫rate de cargar api-adapter.js primero', true);
                setStatus(1, 'error');
            }
        }

        // Test 2: Verificar sesi√≥n de usuario
        function test2() {
            const logDiv = document.getElementById('log2');
            logDiv.innerHTML = '';
            log(2, 'üîÑ Iniciando Test 2...');

            const session = sessionStorage.getItem('currentUser');
            
            if (session) {
                try {
                    const user = JSON.parse(session);
                    log(2, '‚úÖ Sesi√≥n encontrada');
                    log(2, `üë§ Usuario: ${user.username || 'N/A'}`);
                    log(2, `üÜî ID: ${user.id || 'N/A'}`);
                    log(2, `üé≠ Rol: ${user.rol || 'N/A'}`);
                    setStatus(2, 'success');
                } catch (error) {
                    log(2, '‚ùå Error parseando sesi√≥n: ' + error.message, true);
                    setStatus(2, 'error');
                }
            } else {
                log(2, '‚ùå No hay sesi√≥n activa', true);
                log(2, 'üí° Inicia sesi√≥n primero en login.html', true);
                setStatus(2, 'error');
            }
        }

        // Test 3: Test de conexi√≥n con backend
        async function test3() {
            const logDiv = document.getElementById('log3');
            logDiv.innerHTML = '';
            log(3, 'üîÑ Iniciando Test 3...');

            try {
                log(3, `üåê Conectando a: ${API_TEST_URL}/auth.php`);
                
                const response = await fetch(`${API_TEST_URL}/auth.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        action: 'check-session'
                    })
                });

                log(3, `üì° Status: ${response.status} ${response.statusText}`);
                
                const data = await response.json();
                
                if (data.success) {
                    log(3, '‚úÖ Conexi√≥n exitosa con el backend');
                    log(3, `üìä Respuesta: ${JSON.stringify(data, null, 2)}`);
                    setStatus(3, 'success');
                } else {
                    log(3, '‚ö†Ô∏è Backend responde pero indica error', true);
                    log(3, `Error: ${data.error}`, true);
                    setStatus(3, 'error');
                }

            } catch (error) {
                log(3, '‚ùå Error de conexi√≥n: ' + error.message, true);
                log(3, 'üí° Verifica que Apache est√© corriendo', true);
                log(3, 'üí° Verifica la URL en api-adapter.js', true);
                setStatus(3, 'error');
            }
        }

        // Test 4: Obtener historial
        async function test4() {
            const logDiv = document.getElementById('log4');
            logDiv.innerHTML = '';
            log(4, 'üîÑ Iniciando Test 4...');

            if (!window.API) {
                log(4, '‚ùå API Adapter no est√° cargado', true);
                setStatus(4, 'error');
                return;
            }

            try {
                log(4, 'üì• Solicitando historial...');
                
                const { data, error } = await window.API
                    .from('historial')
                    .select('*');

                if (error) {
                    log(4, '‚ùå Error: ' + error.message, true);
                    setStatus(4, 'error');
                } else {
                    log(4, `‚úÖ Historial obtenido: ${data?.length || 0} solicitudes`);
                    if (data && data.length > 0) {
                        log(4, `üìã Primera solicitud: ID ${data[0].id?.substring(0, 8)}, Estado: ${data[0].estado}`);
                    }
                    log(4, `üìä Datos: ${JSON.stringify(data, null, 2)}`);
                    setStatus(4, 'success');
                }

            } catch (error) {
                log(4, '‚ùå Exception: ' + error.message, true);
                setStatus(4, 'error');
            }
        }

        // Test 5: Obtener solicitudes recibidas
        async function test5() {
            const logDiv = document.getElementById('log5');
            logDiv.innerHTML = '';
            log(5, 'üîÑ Iniciando Test 5...');

            if (!window.API) {
                log(5, '‚ùå API Adapter no est√° cargado', true);
                setStatus(5, 'error');
                return;
            }

            try {
                log(5, 'üì• Solicitando lista de recibidos...');
                
                const { data, error } = await window.API
                    .from('historial')
                    .select('solicitud_id');

                if (error) {
                    log(5, '‚ùå Error: ' + error.message, true);
                    setStatus(5, 'error');
                } else {
                    const ids = data || [];
                    log(5, `‚úÖ Recibidos obtenidos: ${ids.length} solicitudes marcadas`);
                    if (ids.length > 0) {
                        log(5, `üìã IDs: ${ids.join(', ')}`);
                    }
                    setStatus(5, 'success');
                }

            } catch (error) {
                log(5, '‚ùå Exception: ' + error.message, true);
                setStatus(5, 'error');
            }
        }

        // Test 6: Marcar como recibido
        async function test6() {
            const logDiv = document.getElementById('log6');
            logDiv.innerHTML = '';
            log(6, 'üîÑ Iniciando Test 6...');

            if (!window.API) {
                log(6, '‚ùå API Adapter no est√° cargado', true);
                setStatus(6, 'error');
                return;
            }

            // Primero obtener una solicitud cerrada
            try {
                log(6, 'üîç Buscando solicitud cerrada para probar...');
                
                const { data: solicitudes } = await window.API
                    .from('historial')
                    .select('*');

                const solicitudCerrada = solicitudes?.find(s => s.estado === 'cerrado');

                if (!solicitudCerrada) {
                    log(6, '‚ö†Ô∏è No hay solicitudes cerradas para probar', true);
                    log(6, 'üí° Primero cierra una solicitud desde el panel admin', true);
                    setStatus(6, 'error');
                    return;
                }

                log(6, `üìã Usando solicitud: ${solicitudCerrada.id.substring(0, 8)}`);
                log(6, '‚úÖ Intentando marcar como recibida...');

                const { data, error } = await window.API
                    .from('historial')
                    .insert({
                        solicitud_id: solicitudCerrada.id
                    });

                if (error) {
                    log(6, '‚ùå Error: ' + error.message, true);
                    if (error.message.includes('ya fue marcada')) {
                        log(6, 'üí° Esta solicitud ya estaba marcada como recibida');
                    }
                    setStatus(6, 'error');
                } else {
                    log(6, '‚úÖ Solicitud marcada como recibida exitosamente');
                    log(6, `üìä Respuesta: ${JSON.stringify(data, null, 2)}`);
                    setStatus(6, 'success');
                }

            } catch (error) {
                log(6, '‚ùå Exception: ' + error.message, true);
                setStatus(6, 'error');
            }
        }

        // Ejecutar todos los tests en secuencia
        async function ejecutarTodos() {
            test1();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            test2();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await test3();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await test4();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await test5();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await test6();
        }
    </script>
</body>
</html>